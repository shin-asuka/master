<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="StudentMapper">
    
    <sql id="studentColumns">student.id AS student_id, student.attended_activities AS student_attended_activities, student.avatar AS student_avatar, student.birthday AS student_birthday, student.customer_stage AS student_customer_stage, student.english_name AS student_english_name, student.grade AS student_grade, student.know_the_student AS student_know_the_student, student.learned_english AS student_learned_english, student.life_cycle AS student_life_cycle, student.notes AS student_notes, student.personality AS student_personality, student.school AS student_school, student.source AS student_source, student.stars AS student_stars, student.training_schools AS student_training_schools, student.welcome AS student_welcome, student.current_performance AS student_current_performance, student.chinese_lead_teacher_id AS student_chinese_lead_teacher_id, student.family_id AS student_family_id, student.foreign_lead_teacher_id AS student_foreign_lead_teacher_id, student.sales_id AS student_sales_id, student.qq AS student_qq, student.assigned_to_sales_date_time_test_two AS student_assigned_to_sales_date_time_test_two, student.assigned_to_sales_date_time AS student_assigned_to_sales_date_time, student.marketing_activity_id AS student_marketing_activity_id, student.invention_code_id AS student_invention_code_id, student.pre_contract_end_time AS student_pre_contract_end_time, student.target_classes_per_week AS student_target_classes_per_week, student.student_type AS student_student_type, student.channel_id AS student_channel_id, student.channel_keyword AS student_channel_keyword</sql>
    
    <sql id="studentWhere">
        <trim prefix="WHERE" prefixOverrides="AND">
            <if test="id!=0">AND student.id = #{id}</if>
            <if test="attendedActivities!=null">AND student.attended_activities = #{attendedActivities}</if>
            <if test="avatar!=null">AND student.avatar = #{avatar}</if>
            <if test="birthday!=null">AND student.birthday = #{birthday}</if>
            <if test="customerStage!=0">AND student.customer_stage = #{customerStage}</if>
            <if test="englishName!=null">AND student.english_name = #{englishName}</if>
            <if test="grade!=null">AND student.grade = #{grade}</if>
            <if test="knowTheStudent!=null">AND student.know_the_student = #{knowTheStudent}</if>
            <if test="learnedEnglish!=0">AND student.learned_english = #{learnedEnglish}</if>
            <if test="lifeCycle!=null">AND student.life_cycle = #{lifeCycle}</if>
            <if test="notes!=null">AND student.notes = #{notes}</if>
            <if test="personality!=null">AND student.personality = #{personality}</if>
            <if test="school!=null">AND student.school = #{school}</if>
            <if test="source!=null">AND student.source = #{source}</if>
            <if test="stars!=0">AND student.stars = #{stars}</if>
            <if test="trainingSchools!=null">AND student.training_schools = #{trainingSchools}</if>
            <if test="welcome!=0">AND student.welcome = #{welcome}</if>
            <if test="currentPerformance!=null">AND student.current_performance = #{currentPerformance}</if>
            <if test="chineseLeadTeacherId!=0">AND student.chinese_lead_teacher_id = #{chineseLeadTeacherId}</if>
            <if test="familyId!=0">AND student.family_id = #{familyId}</if>
            <if test="foreignLeadTeacherId!=0">AND student.foreign_lead_teacher_id = #{foreignLeadTeacherId}</if>
            <if test="salesId!=0">AND student.sales_id = #{salesId}</if>
            <if test="qq!=null">AND student.qq = #{qq}</if>
            <if test="assignedToSalesDateTimeTestTwo!=null">AND student.assigned_to_sales_date_time_test_two = #{assignedToSalesDateTimeTestTwo}</if>
            <if test="assignedToSalesDateTime!=null">AND student.assigned_to_sales_date_time = #{assignedToSalesDateTime}</if>
            <if test="marketingActivityId!=0">AND student.marketing_activity_id = #{marketingActivityId}</if>
            <if test="inventionCodeId!=0">AND student.invention_code_id = #{inventionCodeId}</if>
            <if test="preContractEndTime!=null">AND student.pre_contract_end_time = #{preContractEndTime}</if>
            <if test="targetClassesPerWeek!=0">AND student.target_classes_per_week = #{targetClassesPerWeek}</if>
            <if test="studentType!=null">AND student.student_type = #{studentType}</if>
            <if test="channelId!=0">AND student.channel_id = #{channelId}</if>
            <if test="channelKeyword!=null">AND student.channel_keyword = #{channelKeyword}</if>
        </trim>
    </sql>
    
    <sql id="studentOrder">
        <if test="orderString!=null">ORDER BY ${orderString}</if>
    </sql>
    
    <sql id="studentLimit">LIMIT #{startLine},#{limitLine}</sql>
    
    <resultMap type="com.vipkid.trpm.entity.Student" id="studentResultMap">
        <id column="student_id" property="id" />
        <result column="student_attended_activities" property="attendedActivities" />
        <result column="student_avatar" property="avatar" />
        <result column="student_birthday" property="birthday" />
        <result column="student_customer_stage" property="customerStage" />
        <result column="student_english_name" property="englishName" />
        <result column="student_grade" property="grade" />
        <result column="student_know_the_student" property="knowTheStudent" />
        <result column="student_learned_english" property="learnedEnglish" />
        <result column="student_life_cycle" property="lifeCycle" />
        <result column="student_notes" property="notes" />
        <result column="student_personality" property="personality" />
        <result column="student_school" property="school" />
        <result column="student_source" property="source" />
        <result column="student_stars" property="stars" />
        <result column="student_training_schools" property="trainingSchools" />
        <result column="student_welcome" property="welcome" />
        <result column="student_current_performance" property="currentPerformance" />
        <result column="student_chinese_lead_teacher_id" property="chineseLeadTeacherId" />
        <result column="student_family_id" property="familyId" />
        <result column="student_foreign_lead_teacher_id" property="foreignLeadTeacherId" />
        <result column="student_sales_id" property="salesId" />
        <result column="student_qq" property="qq" />
        <result column="student_assigned_to_sales_date_time_test_two" property="assignedToSalesDateTimeTestTwo" />
        <result column="student_assigned_to_sales_date_time" property="assignedToSalesDateTime" />
        <result column="student_marketing_activity_id" property="marketingActivityId" />
        <result column="student_invention_code_id" property="inventionCodeId" />
        <result column="student_pre_contract_end_time" property="preContractEndTime" />
        <result column="student_target_classes_per_week" property="targetClassesPerWeek" />
        <result column="student_student_type" property="studentType" />
        <result column="student_channel_id" property="channelId" />
        <result column="student_channel_keyword" property="channelKeyword" />
    </resultMap>
    
    <select id="findDao" resultMap="studentResultMap">
        SELECT
        <include refid="studentColumns" />
        FROM student
        <include refid="studentWhere" />
        <include refid="studentOrder" />
    </select>
    
    <select id="countDao" resultType="int">
        SELECT COUNT(*) FROM student
        <include refid="studentWhere" />
    </select>
    
    <select id="pageDao" resultMap="studentResultMap">
        SELECT
        <include refid="studentColumns" />
        FROM student
        <include refid="studentWhere" />
        <include refid="studentOrder" />
        <include refid="studentLimit" />
    </select>
    
    <select id="limitDao" resultMap="studentResultMap">
        SELECT
        <include refid="studentColumns" />
        FROM student
        <include refid="studentWhere" />
        <include refid="studentOrder" />
        <include refid="studentLimit" />
    </select>
    
    <insert id="saveDao" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO student
        <trim prefix="(" prefixOverrides=",">
            <if test="id!=0">,id</if>
            <if test="attendedActivities!=null">,attended_activities</if>
            <if test="avatar!=null">,avatar</if>
            <if test="birthday!=null">,birthday</if>
            <if test="customerStage!=0">,customer_stage</if>
            <if test="englishName!=null">,english_name</if>
            <if test="grade!=null">,grade</if>
            <if test="knowTheStudent!=null">,know_the_student</if>
            <if test="learnedEnglish!=0">,learned_english</if>
            <if test="lifeCycle!=null">,life_cycle</if>
            <if test="notes!=null">,notes</if>
            <if test="personality!=null">,personality</if>
            <if test="school!=null">,school</if>
            <if test="source!=null">,source</if>
            <if test="stars!=0">,stars</if>
            <if test="trainingSchools!=null">,training_schools</if>
            <if test="welcome!=0">,welcome</if>
            <if test="currentPerformance!=null">,current_performance</if>
            <if test="chineseLeadTeacherId!=0">,chinese_lead_teacher_id</if>
            <if test="familyId!=0">,family_id</if>
            <if test="foreignLeadTeacherId!=0">,foreign_lead_teacher_id</if>
            <if test="salesId!=0">,sales_id</if>
            <if test="qq!=null">,qq</if>
            <if test="assignedToSalesDateTimeTestTwo!=null">,assigned_to_sales_date_time_test_two</if>
            <if test="assignedToSalesDateTime!=null">,assigned_to_sales_date_time</if>
            <if test="marketingActivityId!=0">,marketing_activity_id</if>
            <if test="inventionCodeId!=0">,invention_code_id</if>
            <if test="preContractEndTime!=null">,pre_contract_end_time</if>
            <if test="targetClassesPerWeek!=0">,target_classes_per_week</if>
            <if test="studentType!=null">,student_type</if>
            <if test="channelId!=0">,channel_id</if>
            <if test="channelKeyword!=null">,channel_keyword</if>
        </trim>
        ) VALUES
        <trim prefix="(" prefixOverrides=",">
            <if test="id!=0">,#{id}</if>
            <if test="attendedActivities!=null">,#{attendedActivities}</if>
            <if test="avatar!=null">,#{avatar}</if>
            <if test="birthday!=null">,#{birthday}</if>
            <if test="customerStage!=0">,#{customerStage}</if>
            <if test="englishName!=null">,#{englishName}</if>
            <if test="grade!=null">,#{grade}</if>
            <if test="knowTheStudent!=null">,#{knowTheStudent}</if>
            <if test="learnedEnglish!=0">,#{learnedEnglish}</if>
            <if test="lifeCycle!=null">,#{lifeCycle}</if>
            <if test="notes!=null">,#{notes}</if>
            <if test="personality!=null">,#{personality}</if>
            <if test="school!=null">,#{school}</if>
            <if test="source!=null">,#{source}</if>
            <if test="stars!=0">,#{stars}</if>
            <if test="trainingSchools!=null">,#{trainingSchools}</if>
            <if test="welcome!=0">,#{welcome}</if>
            <if test="currentPerformance!=null">,#{currentPerformance}</if>
            <if test="chineseLeadTeacherId!=0">,#{chineseLeadTeacherId}</if>
            <if test="familyId!=0">,#{familyId}</if>
            <if test="foreignLeadTeacherId!=0">,#{foreignLeadTeacherId}</if>
            <if test="salesId!=0">,#{salesId}</if>
            <if test="qq!=null">,#{qq}</if>
            <if test="assignedToSalesDateTimeTestTwo!=null">,#{assignedToSalesDateTimeTestTwo}</if>
            <if test="assignedToSalesDateTime!=null">,#{assignedToSalesDateTime}</if>
            <if test="marketingActivityId!=0">,#{marketingActivityId}</if>
            <if test="inventionCodeId!=0">,#{inventionCodeId}</if>
            <if test="preContractEndTime!=null">,#{preContractEndTime}</if>
            <if test="targetClassesPerWeek!=0">,#{targetClassesPerWeek}</if>
            <if test="studentType!=null">,#{studentType}</if>
            <if test="channelId!=0">,#{channelId}</if>
            <if test="channelKeyword!=null">,#{channelKeyword}</if>
        </trim>
        )
    </insert>
    
    <update id="updateDao">
        UPDATE student
        <trim prefix="SET" prefixOverrides=",">
            <if test="id!=0">,id = #{id}</if>
            <if test="attendedActivities!=null">,attended_activities = #{attendedActivities}</if>
            <if test="avatar!=null">,avatar = #{avatar}</if>
            <if test="birthday!=null">,birthday = #{birthday}</if>
            <if test="customerStage!=0">,customer_stage = #{customerStage}</if>
            <if test="englishName!=null">,english_name = #{englishName}</if>
            <if test="grade!=null">,grade = #{grade}</if>
            <if test="knowTheStudent!=null">,know_the_student = #{knowTheStudent}</if>
            <if test="learnedEnglish!=0">,learned_english = #{learnedEnglish}</if>
            <if test="lifeCycle!=null">,life_cycle = #{lifeCycle}</if>
            <if test="notes!=null">,notes = #{notes}</if>
            <if test="personality!=null">,personality = #{personality}</if>
            <if test="school!=null">,school = #{school}</if>
            <if test="source!=null">,source = #{source}</if>
            <if test="stars!=0">,stars = #{stars}</if>
            <if test="trainingSchools!=null">,training_schools = #{trainingSchools}</if>
            <if test="welcome!=0">,welcome = #{welcome}</if>
            <if test="currentPerformance!=null">,current_performance = #{currentPerformance}</if>
            <if test="chineseLeadTeacherId!=0">,chinese_lead_teacher_id = #{chineseLeadTeacherId}</if>
            <if test="familyId!=0">,family_id = #{familyId}</if>
            <if test="foreignLeadTeacherId!=0">,foreign_lead_teacher_id = #{foreignLeadTeacherId}</if>
            <if test="salesId!=0">,sales_id = #{salesId}</if>
            <if test="qq!=null">,qq = #{qq}</if>
            <if test="assignedToSalesDateTimeTestTwo!=null">,assigned_to_sales_date_time_test_two = #{assignedToSalesDateTimeTestTwo}</if>
            <if test="assignedToSalesDateTime!=null">,assigned_to_sales_date_time = #{assignedToSalesDateTime}</if>
            <if test="marketingActivityId!=0">,marketing_activity_id = #{marketingActivityId}</if>
            <if test="inventionCodeId!=0">,invention_code_id = #{inventionCodeId}</if>
            <if test="preContractEndTime!=null">,pre_contract_end_time = #{preContractEndTime}</if>
            <if test="targetClassesPerWeek!=0">,target_classes_per_week = #{targetClassesPerWeek}</if>
            <if test="studentType!=null">,student_type = #{studentType}</if>
            <if test="channelId!=0">,channel_id = #{channelId}</if>
            <if test="channelKeyword!=null">,channel_keyword = #{channelKeyword}</if>
        </trim>
        <trim prefix="WHERE" prefixOverrides="AND">AND id = #{id}</trim>
    </update>
    
    <delete id="deleteDao">
        DELETE FROM student
        <trim prefix="WHERE" prefixOverrides="AND">AND id = #{id}</trim>
    </delete>
    
    <select id="findMaxNumber" resultType="java.util.HashMap">
		select MAX(id) as num from user;
	</select>
	
	<!-- 根据家长id查询学生 -->
	<select id="findByParentId" resultMap="studentResultMap">
        SELECT
        <include refid="studentColumns" />
        FROM student, parent where student.family_id = parent.family_id and parent.id = #{parentId};
    </select>
    
    <!-- 根据学生Id查询家长Id -->
    <select id="findWechatBystudentId" resultType="java.util.HashMap">
    	SELECT w.open_id as openId FROM wechat_binding w WHERE w.user_id in ( SELECT p.id FROM parent p WHERE p.family_id = (SELECT s.family_id FROM student s WHERE s.id = #{studentId}))
    </select>
    
    <!-- 根据课程id查询学生 -->
	<select id="findStudentByOnlineClassId" resultMap="studentResultMap">
        SELECT
        	<include refid="studentColumns" />,user.name as name
        FROM student
        	JOIN online_class_student  ON online_class_student.student_id = student.id
            JOIN user ON (student.id = user.id)
        where 
       		online_class_student.online_class_id = #{onlineClassId}
    </select>
    
    <!-- 根据学生ID和日期查询订单信息列表 -->
    <select id="findOrderListByStudentIdAndPaidDateTime" resultType="java.util.HashMap">
        select 
        	a.id,a.student_id,a.real_total_price ,a.confirm_date_time
        from pack_order a
		where a.student_id=#{studentId}
			and a.status='PAY_CONFIRMED'
			and a.real_total_price is not null and a.real_total_price>500
			and a.confirm_date_time between concat(#{startDate},' 00:00:00') and concat(#{endDate},' 23:59:59')
    </select>

    <select id="findStudentsByIds" resultType="java.util.HashMap">
    	SELECT 
		  student.id AS id,
		  student.english_name AS englishName,
		  student.avatar AS avatar,
		  user.gender AS gender
		FROM
		  student
		  INNER JOIN user ON (student.id = user.id)
		WHERE
		  student.id IN 
        <foreach collection="ids" open="(" close=")" separator="," item="id">
        	<if test="id!=0"> #{id} </if>
        </foreach>
    </select>
    
</mapper>
