<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="LessonMapper">

	<sql id="lessonColumns">lesson.id AS lesson_id, lesson.dby_document AS
		lesson_dby_document, lesson.domain AS
		lesson_domain, lesson.goal AS
		lesson_goal, lesson.lss_target AS lesson_lss_target,
		lesson.math_target AS lesson_math_target, lesson.name AS lesson_name,
		lesson.objective AS
		lesson_objective, lesson.review_target AS
		lesson_review_target, lesson.sentence_patterns AS
		lesson_sentence_patterns, lesson.sequence AS lesson_sequence,
		lesson.serial_number AS
		lesson_serial_number, lesson.topic AS
		lesson_topic, lesson.vocabularies AS lesson_vocabularies,
		lesson.learning_cycle_id AS lesson_learning_cycle_id, lesson.number AS
		lesson_number
	</sql>

	<sql id="lessonWhere">
		<trim prefix="WHERE" prefixOverrides="AND">
			<if test="id!=0">AND lesson.id = #{id}</if>
			<if test="dbyDocument!=null">AND lesson.dby_document = #{dbyDocument}</if>
			<if test="domain!=null">AND lesson.domain = #{domain}</if>
			<if test="goal!=null">AND lesson.goal = #{goal}</if>
			<if test="lssTarget!=null">AND lesson.lss_target = #{lssTarget}</if>
			<if test="mathTarget!=null">AND lesson.math_target = #{mathTarget}</if>
			<if test="name!=null">AND lesson.name = #{name}</if>
			<if test="objective!=null">AND lesson.objective = #{objective}</if>
			<if test="reviewTarget!=null">AND lesson.review_target = #{reviewTarget}</if>
			<if test="sentencePatterns!=null">AND lesson.sentence_patterns = #{sentencePatterns}</if>
			<if test="sequence!=0">AND lesson.sequence = #{sequence}</if>
			<if test="serialNumber!=null">AND lesson.serial_number = #{serialNumber}</if>
			<if test="topic!=null">AND lesson.topic = #{topic}</if>
			<if test="vocabularies!=null">AND lesson.vocabularies = #{vocabularies}</if>
			<if test="learningCycleId!=0">AND lesson.learning_cycle_id = #{learningCycleId}</if>
			<if test="number!=null">AND lesson.number = #{number}</if>
		</trim>
	</sql>

	<sql id="lessonOrder">
		<if test="orderString!=null">ORDER BY ${orderString}</if>
	</sql>

	<sql id="lessonLimit">LIMIT #{startLine},#{limitLine}</sql>

	<resultMap type="com.vipkid.trpm.entity.Lesson" id="lessonResultMap">
		<id column="lesson_id" property="id" />
		<result column="lesson_dby_document" property="dbyDocument" />
		<result column="lesson_domain" property="domain" />
		<result column="lesson_goal" property="goal" />
		<result column="lesson_lss_target" property="lssTarget" />
		<result column="lesson_math_target" property="mathTarget" />
		<result column="lesson_name" property="name" />
		<result column="lesson_objective" property="objective" />
		<result column="lesson_review_target" property="reviewTarget" />
		<result column="lesson_sentence_patterns" property="sentencePatterns" />
		<result column="lesson_sequence" property="sequence" />
		<result column="lesson_serial_number" property="serialNumber" />
		<result column="lesson_topic" property="topic" />
		<result column="lesson_vocabularies" property="vocabularies" />
		<result column="lesson_learning_cycle_id" property="learningCycleId" />
		<result column="lesson_number" property="number" />
	</resultMap>

	<select id="findDao" resultMap="lessonResultMap" useCache="true">
		SELECT
		<include refid="lessonColumns" />
		FROM lesson
		<include refid="lessonWhere" />
		<include refid="lessonOrder" />
	</select>

	<select id="countDao" resultType="int" useCache="true">
		SELECT COUNT(*) FROM lesson
		<include refid="lessonWhere" />
	</select>

	<select id="pageDao" resultMap="lessonResultMap" useCache="true">
		SELECT
		<include refid="lessonColumns" />
		FROM lesson
		<include refid="lessonWhere" />
		<include refid="lessonOrder" />
		<include refid="lessonLimit" />
	</select>

	<select id="limitDao" resultMap="lessonResultMap" useCache="true">
		SELECT
		<include refid="lessonColumns" />
		FROM lesson
		<include refid="lessonWhere" />
		<include refid="lessonOrder" />
		<include refid="lessonLimit" />
	</select>

	<insert id="saveDao" useGeneratedKeys="true" keyProperty="id" flushCache="true">
		INSERT INTO lesson
		<trim prefix="(" prefixOverrides=",">
			<if test="id!=0">,id</if>
			<if test="dbyDocument!=null">,dby_document</if>
			<if test="domain!=null">,domain</if>
			<if test="goal!=null">,goal</if>
			<if test="lssTarget!=null">,lss_target</if>
			<if test="mathTarget!=null">,math_target</if>
			<if test="name!=null">,name</if>
			<if test="objective!=null">,objective</if>
			<if test="reviewTarget!=null">,review_target</if>
			<if test="sentencePatterns!=null">,sentence_patterns</if>
			<if test="sequence!=0">,sequence</if>
			<if test="serialNumber!=null">,serial_number</if>
			<if test="topic!=null">,topic</if>
			<if test="vocabularies!=null">,vocabularies</if>
			<if test="learningCycleId!=0">,learning_cycle_id</if>
			<if test="number!=null">,number</if>
		</trim>
		) VALUES
		<trim prefix="(" prefixOverrides=",">
			<if test="id!=0">,#{id}</if>
			<if test="dbyDocument!=null">,#{dbyDocument}</if>
			<if test="domain!=null">,#{domain}</if>
			<if test="goal!=null">,#{goal}</if>
			<if test="lssTarget!=null">,#{lssTarget}</if>
			<if test="mathTarget!=null">,#{mathTarget}</if>
			<if test="name!=null">,#{name}</if>
			<if test="objective!=null">,#{objective}</if>
			<if test="reviewTarget!=null">,#{reviewTarget}</if>
			<if test="sentencePatterns!=null">,#{sentencePatterns}</if>
			<if test="sequence!=0">,#{sequence}</if>
			<if test="serialNumber!=null">,#{serialNumber}</if>
			<if test="topic!=null">,#{topic}</if>
			<if test="vocabularies!=null">,#{vocabularies}</if>
			<if test="learningCycleId!=0">,#{learningCycleId}</if>
			<if test="number!=null">,#{number}</if>
		</trim>
		)
	</insert>

	<update id="updateDao" flushCache="true">
		UPDATE lesson
		<trim prefix="SET" prefixOverrides=",">
			<if test="id!=0">,id = #{id}</if>
			<if test="dbyDocument!=null">,dby_document = #{dbyDocument}</if>
			<if test="domain!=null">,domain = #{domain}</if>
			<if test="goal!=null">,goal = #{goal}</if>
			<if test="lssTarget!=null">,lss_target = #{lssTarget}</if>
			<if test="mathTarget!=null">,math_target = #{mathTarget}</if>
			<if test="name!=null">,name = #{name}</if>
			<if test="objective!=null">,objective = #{objective}</if>
			<if test="reviewTarget!=null">,review_target = #{reviewTarget}</if>
			<if test="sentencePatterns!=null">,sentence_patterns = #{sentencePatterns}</if>
			<if test="sequence!=0">,sequence = #{sequence}</if>
			<if test="serialNumber!=null">,serial_number = #{serialNumber}</if>
			<if test="topic!=null">,topic = #{topic}</if>
			<if test="vocabularies!=null">,vocabularies = #{vocabularies}</if>
			<if test="learningCycleId!=0">,learning_cycle_id = #{learningCycleId}</if>
			<if test="number!=null">,number = #{number}</if>
		</trim>
		<trim prefix="WHERE" prefixOverrides="AND">AND id = #{id}</trim>
	</update>

	<delete id="deleteDao" flushCache="true">
		DELETE FROM lesson
		<trim prefix="WHERE" prefixOverrides="AND">AND id = #{id}</trim>
	</delete>

	<!-- 通过课程类型查询Lesson -->
	<select id="findByCourseType" resultMap="lessonResultMap" useCache="true">
		SELECT
		<include refid="lessonColumns" />
		FROM course
		INNER JOIN unit ON (course.id = unit.course_id)
		INNER JOIN learning_cycle ON (unit.id = learning_cycle.unit_id)
		INNER JOIN lesson ON (learning_cycle.id = lesson.learning_cycle_id)
		WHERE
		course.type = #{courseType}
	</select>
	
	<!-- 通过课程id查询Lesson -->
	<select id="findByCourseId" resultMap="lessonResultMap" useCache="true">
        SELECT
        <include refid="lessonColumns" />
        FROM lesson
        INNER JOIN learning_cycle ON (lesson.learning_cycle_id = learning_cycle.id)
        INNER JOIN unit ON (learning_cycle.unit_id = unit.id)
        INNER JOIN course ON (unit.course_id = course.id)
        WHERE
        course.id = #{courseId}
        GROUP BY lesson.id
        ORDER BY lesson.sequence
    </select>

</mapper>
