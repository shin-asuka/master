<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="CourseMapper">

	<sql id="courseColumns">course.id AS course_id, course.base_class_salary AS
		course_base_class_salary,
		course.create_date_time AS
		course_create_date_time, course.description AS course_description,
		course.free AS course_free, course.mode AS course_mode, course.name AS
		course_name,
		course.need_backup_teacher AS course_need_backup_teacher,
		course.sequential AS course_sequential,
		course.serial_number AS
		course_serial_number, course.type AS course_type, course.entry_unit_id
		AS
		course_entry_unit_id, course.show_name AS course_show_name,
		course.childtype AS course_childtype
	</sql>

	<sql id="courseWhere">
		<trim prefix="WHERE" prefixOverrides="AND">
			<if test="id!=0">AND course.id = #{id}</if>
			<if test="baseClassSalary!=0.0">AND course.base_class_salary = #{baseClassSalary}</if>
			<if test="createDateTime!=null">AND course.create_date_time = #{createDateTime}</if>
			<if test="description!=null">AND course.description = #{description}</if>
			<if test="free!=0">AND course.free = #{free}</if>
			<if test="mode!=null">AND course.mode = #{mode}</if>
			<if test="name!=null">AND course.name = #{name}</if>
			<if test="needBackupTeacher!=0">AND course.need_backup_teacher = #{needBackupTeacher}
			</if>
			<if test="sequential!=0">AND course.sequential = #{sequential}</if>
			<if test="serialNumber!=null">AND course.serial_number = #{serialNumber}</if>
			<if test="type!=null">AND course.type = #{type}</if>
			<if test="entryUnitId!=0">AND course.entry_unit_id = #{entryUnitId}</if>
			<if test="showName!=null">AND course.show_name = #{showName}</if>
			<if test="childtype!=null">AND course.childtype = #{childtype}</if>
		</trim>
	</sql>

	<sql id="courseOrder">
		<if test="orderString!=null">ORDER BY ${orderString}</if>
	</sql>

	<sql id="courseLimit">LIMIT #{startLine},#{limitLine}</sql>

	<resultMap type="com.vipkid.trpm.entity.Course" id="courseResultMap">
		<id column="course_id" property="id" />
		<result column="course_base_class_salary" property="baseClassSalary" />
		<result column="course_create_date_time" property="createDateTime" />
		<result column="course_description" property="description" />
		<result column="course_free" property="free" />
		<result column="course_mode" property="mode" />
		<result column="course_name" property="name" />
		<result column="course_need_backup_teacher" property="needBackupTeacher" />
		<result column="course_sequential" property="sequential" />
		<result column="course_serial_number" property="serialNumber" />
		<result column="course_type" property="type" />
		<result column="course_entry_unit_id" property="entryUnitId" />
		<result column="course_show_name" property="showName" />
		<result column="course_childtype" property="childtype" />
	</resultMap>

	<select id="findDao" resultMap="courseResultMap" useCache="true">
		SELECT
		<include refid="courseColumns" />
		FROM course
		<include refid="courseWhere" />
		<include refid="courseOrder" />
	</select>

	<select id="countDao" resultType="int" useCache="true">
		SELECT COUNT(*) FROM course
		<include refid="courseWhere" />
	</select>

	<select id="pageDao" resultMap="courseResultMap" useCache="true">
		SELECT
		<include refid="courseColumns" />
		FROM course
		<include refid="courseWhere" />
		<include refid="courseOrder" />
		<include refid="courseLimit" />
	</select>

	<select id="limitDao" resultMap="courseResultMap" useCache="true">
		SELECT
		<include refid="courseColumns" />
		FROM course
		<include refid="courseWhere" />
		<include refid="courseOrder" />
		<include refid="courseLimit" />
	</select>

	<insert id="saveDao" useGeneratedKeys="true" keyProperty="id" flushCache="true">
		INSERT INTO course
		<trim prefix="(" prefixOverrides=",">
			<if test="id!=0">,id</if>
			<if test="baseClassSalary!=0.0">,base_class_salary</if>
			<if test="createDateTime!=null">,create_date_time</if>
			<if test="description!=null">,description</if>
			<if test="free!=0">,free</if>
			<if test="mode!=null">,mode</if>
			<if test="name!=null">,name</if>
			<if test="needBackupTeacher!=0">,need_backup_teacher</if>
			<if test="sequential!=0">,sequential</if>
			<if test="serialNumber!=null">,serial_number</if>
			<if test="type!=null">,type</if>
			<if test="entryUnitId!=0">,entry_unit_id</if>
			<if test="showName!=null">,show_name</if>
			<if test="childtype!=null">,childtype</if>
		</trim>
		) VALUES
		<trim prefix="(" prefixOverrides=",">
			<if test="id!=0">,#{id}</if>
			<if test="baseClassSalary!=0.0">,#{baseClassSalary}</if>
			<if test="createDateTime!=null">,#{createDateTime}</if>
			<if test="description!=null">,#{description}</if>
			<if test="free!=0">,#{free}</if>
			<if test="mode!=null">,#{mode}</if>
			<if test="name!=null">,#{name}</if>
			<if test="needBackupTeacher!=0">,#{needBackupTeacher}</if>
			<if test="sequential!=0">,#{sequential}</if>
			<if test="serialNumber!=null">,#{serialNumber}</if>
			<if test="type!=null">,#{type}</if>
			<if test="entryUnitId!=0">,#{entryUnitId}</if>
			<if test="showName!=null">,#{showName}</if>
			<if test="childtype!=null">,#{childtype}</if>
		</trim>
		)
	</insert>

	<update id="updateDao" flushCache="true">
		UPDATE course
		<trim prefix="SET" prefixOverrides=",">
			<if test="id!=0">,id = #{id}</if>
			<if test="baseClassSalary!=0.0">,base_class_salary = #{baseClassSalary}</if>
			<if test="createDateTime!=null">,create_date_time = #{createDateTime}</if>
			<if test="description!=null">,description = #{description}</if>
			<if test="free!=0">,free = #{free}</if>
			<if test="mode!=null">,mode = #{mode}</if>
			<if test="name!=null">,name = #{name}</if>
			<if test="needBackupTeacher!=0">,need_backup_teacher = #{needBackupTeacher}</if>
			<if test="sequential!=0">,sequential = #{sequential}</if>
			<if test="serialNumber!=null">,serial_number = #{serialNumber}</if>
			<if test="type!=null">,type = #{type}</if>
			<if test="entryUnitId!=0">,entry_unit_id = #{entryUnitId}</if>
			<if test="showName!=null">,show_name = #{showName}</if>
			<if test="childtype!=null">,childtype = #{childtype}</if>
		</trim>
		<trim prefix="WHERE" prefixOverrides="AND">AND id = #{id}</trim>
	</update>

	<delete id="deleteDao" flushCache="true">
		DELETE FROM course
		<trim prefix="WHERE" prefixOverrides="AND">AND id = #{id}</trim>
	</delete>

	<!-- 通过TeacherId查询老师可以教的课程列表 -->
	<select id="findByTeacherId" resultMap="courseResultMap" useCache="false">
		SELECT
		<include refid="courseColumns" />
		FROM course 
		INNER JOIN teacher_certificated_course ON (course.id = teacher_certificated_course.course_id) 
		WHERE teacher_certificated_course.teacher_id = #{teacherId}
	</select>
	
	<!-- 通过LessonId查询课程 -->
	<select id="findByLessonId" resultMap="courseResultMap" useCache="true">
        SELECT
        <include refid="courseColumns" />
        FROM lesson
        INNER JOIN learning_cycle ON (lesson.learning_cycle_id = learning_cycle.id)
        INNER JOIN unit ON (learning_cycle.unit_id = unit.id)
        INNER JOIN course ON (unit.course_id = course.id)
        WHERE
        lesson.id = #{lessonId}
    </select>

</mapper>
