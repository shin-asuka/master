<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="TeacherCommentMapper">

	<sql id="teacherCommentColumns">teacher_comment.id AS teacher_comment_id,
		teacher_comment.ability_to_follow_instructions AS
		teacher_comment_ability_to_follow_instructions,
		teacher_comment.actively_interaction AS
		teacher_comment_actively_interaction,
		teacher_comment.clear_pronunciation AS
		teacher_comment_clear_pronunciation,
		teacher_comment.create_date_time
		AS teacher_comment_create_date_time, teacher_comment.empty AS
		teacher_comment_empty, teacher_comment.reading_skills AS
		teacher_comment_reading_skills,
		teacher_comment.repetition AS
		teacher_comment_repetition, teacher_comment.report_issues AS
		teacher_comment_report_issues, teacher_comment.spelling_accuracy AS
		teacher_comment_spelling_accuracy, teacher_comment.stars AS
		teacher_comment_stars,
		teacher_comment.teacher_feedback AS
		teacher_comment_teacher_feedback,
		teacher_comment.feedback_translation
		AS teacher_comment_feedback_translation,
		teacher_comment.tips_for_other_teachers AS
		teacher_comment_tips_for_other_teachers,
		teacher_comment.urgent AS
		teacher_comment_urgent, teacher_comment.performance AS
		teacher_comment_performance, teacher_comment.performance_adjust AS
		teacher_comment_performance_adjust, teacher_comment.current_performance AS
		teacher_comment_current_performance, teacher_comment.online_class_id
		AS
		teacher_comment_online_class_id, teacher_comment.student_id AS
		teacher_comment_student_id,
		teacher_comment.teacher_id AS
		teacher_comment_teacher_id, teacher_comment.operator_id AS
		teacher_comment_operator_id, teacher_comment.trial_level_result AS
		teacher_comment_trial_level_result,teacher_comment.first_date_time
		teacher_comment_first_date_time,teacher_comment.last_date_time
		teacher_comment_last_date_time
	</sql>

	<sql id="teacherCommentWhere">
		<trim prefix="WHERE" prefixOverrides="AND">
			<if test="id!=0">AND teacher_comment.id = #{id}</if>
			<if test="abilityToFollowInstructions!=0">AND teacher_comment.ability_to_follow_instructions =
				#{abilityToFollowInstructions}
			</if>
			<if test="activelyInteraction!=0">AND teacher_comment.actively_interaction =
				#{activelyInteraction}
			</if>
			<if test="clearPronunciation!=0">AND teacher_comment.clear_pronunciation =
				#{clearPronunciation}
			</if>
			<if test="createDateTime!=null">AND teacher_comment.create_date_time = #{createDateTime}
			</if>
			<if test="empty!=0">AND teacher_comment.empty = #{empty}</if>
			<if test="readingSkills!=0">AND teacher_comment.reading_skills = #{readingSkills}
			</if>
			<if test="repetition!=0">AND teacher_comment.repetition = #{repetition}</if>
			<if test="reportIssues!=null">AND teacher_comment.report_issues = #{reportIssues}</if>
			<if test="spellingAccuracy!=0">AND teacher_comment.spelling_accuracy =
				#{spellingAccuracy}
			</if>
			<if test="stars!=0">AND teacher_comment.stars = #{stars}</if>
			<if test="teacherFeedback!=null">AND teacher_comment.teacher_feedback = #{teacherFeedback}
			</if>
			<if test="feedbackTranslation!=null">AND teacher_comment.feedback_translation =
				#{feedbackTranslation}
			</if>
			<if test="tipsForOtherTeachers!=null">AND teacher_comment.tips_for_other_teachers =
				#{tipsForOtherTeachers}
			</if>
			<if test="urgent!=0">AND teacher_comment.urgent = #{urgent}</if>
			<if test="performance!=0">AND teacher_comment.performance = #{performance}</if>
			<if test="performanceAdjust!=0">AND teacher_comment.performance_adjust = #{performanceAdjust}</if>
			<if test="currentPerformance!=null">AND teacher_comment.current_performance =
				#{currentPerformance}
			</if>
			<if test="onlineClassId!=0">AND teacher_comment.online_class_id = #{onlineClassId}
			</if>
			<if test="studentId!=0">AND teacher_comment.student_id = #{studentId}</if>
			<if test="teacherId!=0">AND teacher_comment.teacher_id = #{teacherId}</if>
			<if test="operatorId!=0">AND teacher_comment.operator_id = #{operatorId}</if>
			<if test="trialLevelResult!=null">AND teacher_comment.trial_level_result =
				#{trialLevelResult}
			</if>
			<if test="firstDateTime!=null">AND teacher_comment.first_date_time = #{firstDateTime}</if>
			<if test="lastDateTime!=null">AND teacher_comment.last_date_time = #{lastDateTime}</if>
		</trim>
	</sql>

	<sql id="teacherCommentOrder">
		<if test="orderString!=null">ORDER BY ${orderString}</if>
	</sql>

	<sql id="teacherCommentLimit">LIMIT #{startLine},#{limitLine}</sql>

	<resultMap type="com.vipkid.trpm.entity.TeacherComment" id="teacherCommentResultMap">
		<id column="teacher_comment_id" property="id" />
		<result column="teacher_comment_ability_to_follow_instructions" property="abilityToFollowInstructions" />
		<result column="teacher_comment_actively_interaction" property="activelyInteraction" />
		<result column="teacher_comment_clear_pronunciation" property="clearPronunciation" />
		<result column="teacher_comment_create_date_time" property="createDateTime" />
		<result column="teacher_comment_empty" property="empty" />
		<result column="teacher_comment_reading_skills" property="readingSkills" />
		<result column="teacher_comment_repetition" property="repetition" />
		<result column="teacher_comment_report_issues" property="reportIssues" />
		<result column="teacher_comment_spelling_accuracy" property="spellingAccuracy" />
		<result column="teacher_comment_stars" property="stars" />
		<result column="teacher_comment_teacher_feedback" property="teacherFeedback" />
		<result column="teacher_comment_feedback_translation" property="feedbackTranslation" />
		<result column="teacher_comment_tips_for_other_teachers" property="tipsForOtherTeachers" />
		<result column="teacher_comment_urgent" property="urgent" />
		<result column="teacher_comment_performance" property="performance" />
		<result column="teacher_comment_performance_adjust" property="performanceAdjust" />
		<result column="teacher_comment_current_performance" property="currentPerformance" />
		<result column="teacher_comment_online_class_id" property="onlineClassId" />
		<result column="teacher_comment_student_id" property="studentId" />
		<result column="teacher_comment_teacher_id" property="teacherId" />
		<result column="teacher_comment_operator_id" property="operatorId" />
		<result column="teacher_comment_trial_level_result" property="trialLevelResult" />
		<result column="teacher_comment_first_date_time" property="firstDateTime" />
		<result column="teacher_comment_last_date_time" property="lastDateTime" />
	</resultMap>

	<select id="findDao" resultMap="teacherCommentResultMap" useCache="false">
		SELECT
		<include refid="teacherCommentColumns" />
		FROM teacher_comment
		<include refid="teacherCommentWhere" />
		<include refid="teacherCommentOrder" />
	</select>

	<select id="countDao" resultType="int" useCache="false">
		SELECT COUNT(*) FROM teacher_comment
		<include refid="teacherCommentWhere" />
	</select>

	<select id="pageDao" resultMap="teacherCommentResultMap" useCache="false">
		SELECT
		<include refid="teacherCommentColumns" />
		FROM teacher_comment
		<include refid="teacherCommentWhere" />
		<include refid="teacherCommentOrder" />
		<include refid="teacherCommentLimit" />
	</select>

	<select id="limitDao" resultMap="teacherCommentResultMap" useCache="false">
		SELECT
		<include refid="teacherCommentColumns" />
		FROM teacher_comment
		<include refid="teacherCommentWhere" />
		<include refid="teacherCommentOrder" />
		<include refid="teacherCommentLimit" />
	</select>

	<insert id="saveDao" useGeneratedKeys="true" keyProperty="id" flushCache="true">
		INSERT INTO teacher_comment
		<trim prefix="(" prefixOverrides=",">
			<if test="id!=0">,id</if>
			<if test="abilityToFollowInstructions!=0">,ability_to_follow_instructions</if>
			<if test="activelyInteraction!=0">,actively_interaction</if>
			<if test="clearPronunciation!=0">,clear_pronunciation</if>
			<if test="createDateTime!=null">,create_date_time</if>
			<if test="empty!=0">,empty</if>
			<if test="readingSkills!=0">,reading_skills</if>
			<if test="repetition!=0">,repetition</if>
			<if test="reportIssues!=null">,report_issues</if>
			<if test="spellingAccuracy!=0">,spelling_accuracy</if>
			<if test="stars!=0">,stars</if>
			<if test="teacherFeedback!=null">,teacher_feedback</if>
			<if test="feedbackTranslation!=null">,feedback_translation</if>
			<if test="tipsForOtherTeachers!=null">,tips_for_other_teachers</if>
			<if test="urgent!=0">,urgent</if>
			<if test="performance!=0">,performance</if>
			<if test="performanceAdjust!=0">,performance_adjust</if>
			<if test="currentPerformance!=null">,current_performance</if>
			<if test="onlineClassId!=0">,online_class_id</if>
			<if test="studentId!=0">,student_id</if>
			<if test="teacherId!=0">,teacher_id</if>
			<if test="operatorId!=0">,operator_id</if>
			<if test="trialLevelResult!=null">,trial_level_result</if>
			<if test="firstDateTime!=null">,first_date_time</if>
			<if test="lastDateTime!=null">,last_date_time</if>
		</trim>
		) VALUES
		<trim prefix="(" prefixOverrides=",">
			<if test="id!=0">,#{id}</if>
			<if test="abilityToFollowInstructions!=0">,#{abilityToFollowInstructions}</if>
			<if test="activelyInteraction!=0">,#{activelyInteraction}</if>
			<if test="clearPronunciation!=0">,#{clearPronunciation}</if>
			<if test="createDateTime!=null">,#{createDateTime}</if>
			<if test="empty!=0">,#{empty}</if>
			<if test="readingSkills!=0">,#{readingSkills}</if>
			<if test="repetition!=0">,#{repetition}</if>
			<if test="reportIssues!=null">,#{reportIssues}</if>
			<if test="spellingAccuracy!=0">,#{spellingAccuracy}</if>
			<if test="stars!=0">,#{stars}</if>
			<if test="teacherFeedback!=null">,#{teacherFeedback}</if>
			<if test="feedbackTranslation!=null">,#{feedbackTranslation}</if>
			<if test="tipsForOtherTeachers!=null">,#{tipsForOtherTeachers}</if>
			<if test="urgent!=0">,#{urgent}</if>
			<if test="performance!=0">,#{performance}</if>
			<if test="performanceAdjust!=0">,#{performanceAdjust}</if>
			<if test="currentPerformance!=null">,#{currentPerformance}</if>
			<if test="onlineClassId!=0">,#{onlineClassId}</if>
			<if test="studentId!=0">,#{studentId}</if>
			<if test="teacherId!=0">,#{teacherId}</if>
			<if test="operatorId!=0">,#{operatorId}</if>
			<if test="trialLevelResult!=null">,#{trialLevelResult}</if>
			<if test="firstDateTime!=null">,firstDateTime</if>
			<if test="lastDateTime!=null">,lastDateTime</if>
		</trim>
		)
	</insert>

	<update id="updateDao" flushCache="true">
		UPDATE teacher_comment
		<trim prefix="SET" prefixOverrides=",">
			<if test="id!=0">,id = #{id}</if>
			<if test="abilityToFollowInstructions!=0">,ability_to_follow_instructions =
				#{abilityToFollowInstructions}
			</if>
			<if test="activelyInteraction!=0">,actively_interaction = #{activelyInteraction}</if>
			<if test="clearPronunciation!=0">,clear_pronunciation = #{clearPronunciation}</if>
			<if test="createDateTime!=null">,create_date_time = #{createDateTime}</if>
			<if test="empty!=0">,empty = #{empty}</if>
			<if test="readingSkills!=0">,reading_skills = #{readingSkills}</if>
			<if test="repetition!=0">,repetition = #{repetition}</if>
			<if test="reportIssues!=null">,report_issues = #{reportIssues}</if>
			<if test="spellingAccuracy!=0">,spelling_accuracy = #{spellingAccuracy}</if>
			<if test="stars!=0">,stars = #{stars}</if>
			<if test="teacherFeedback!=null">,teacher_feedback = #{teacherFeedback}</if>
			<if test="feedbackTranslation!=null">,feedback_translation = #{feedbackTranslation}</if>
			<if test="tipsForOtherTeachers!=null">,tips_for_other_teachers = #{tipsForOtherTeachers}</if>
			<if test="urgent!=0">,urgent = #{urgent}</if>
			<if test="performance!=0">,performance = #{performance}</if>
			<if test="performanceAdjust!=0">,performance_adjust = #{performanceAdjust}</if>
			<if test="currentPerformance!=null">,current_performance = #{currentPerformance}</if>
			<if test="onlineClassId!=0">,online_class_id = #{onlineClassId}</if>
			<if test="studentId!=0">,student_id = #{studentId}</if>
			<if test="teacherId!=0">,teacher_id = #{teacherId}</if>
			<if test="operatorId!=0">,operator_id = #{operatorId}</if>
			<if test="trialLevelResult!=null">,trial_level_result = #{trialLevelResult}</if>
			<if test="firstDateTime!=null">,first_date_time = #{firstDateTime}</if>
			<if test="lastDateTime!=null">,last_date_time = #{lastDateTime}</if>
		</trim>
		<trim prefix="WHERE" prefixOverrides="AND">AND id = #{id}</trim>
	</update>

	<delete id="deleteDao" flushCache="true">
		DELETE FROM teacher_comment
		<trim prefix="WHERE" prefixOverrides="AND">AND id = #{id}</trim>
	</delete>

	<!-- 通过StudentId查询Comments -->
	<select id="findCommentsByStudentId" resultType="java.util.HashMap" useCache="false">
		SELECT
		lesson.serial_number AS serial_number,
		teacher_comment.tips_for_other_teachers AS
		tips_for_other_teachers,
		teacher_comment.create_date_time AS create_date_time,
		online_class.lesson_id AS lesson_id
		FROM
		online_class INNER JOIN teacher_comment ON online_class.id
		= teacher_comment.online_class_id
		INNER JOIN lesson ON online_class.lesson_id = lesson.id
		WHERE
		teacher_comment.student_id = #{studentId} AND
		teacher_comment.tips_for_other_teachers IS NOT NULL
		GROUP BY online_class.id
		ORDER BY teacher_comment.id DESC
		LIMIT 5
	</select>

	<!-- 通过TeacherId,MonthOfYear查询Not Like Assertment 的 Comments总数 -->
	<select id="countByTeacherIdAndMonthOfYearAndNotLike" resultType="int" useCache="false">
		SELECT
		COUNT(DISTINCT
		teacher_comment.online_class_id)
		FROM
		online_class_student
		INNER JOIN student ON (online_class_student.student_id = student.id)
		INNER JOIN online_class ON (online_class_student.online_class_id = online_class.id)
		INNER JOIN teacher_comment ON (online_class.id = teacher_comment.online_class_id)
		INNER JOIN lesson ON (online_class.lesson_id = lesson.id)
		WHERE
		online_class.teacher_id = #{teacherId} 
        AND lesson.serial_number NOT LIKE 'A%' 
        AND online_class.status != 'INVALID' 
        AND CONVERT_TZ(online_class.scheduled_date_time,'+08:00',#{toTZOffset}) LIKE CONCAT('',#{monthOfYear},'%')
	</select>

    <!-- 通过TeacherId,MonthOfYear查询Not Like Assertment 的 Comments列表 -->
	<select id="findByTeacherIdAndMonthOfYearAndNotLike" resultType="java.util.HashMap" useCache="false">
		SELECT
		student.english_name AS studentEnglishName,
		online_class.id AS onlineclassId,
		online_class.lesson_id AS lessonId,
		lesson.serial_number AS lesssonSerialNumber,
		lesson.name AS lessonName,
		online_class.teacher_id AS teacherId,
		online_class.scheduled_date_time AS scheduledDateTime,
		teacher_comment.ability_to_follow_instructions AS abilityToFollowInstructions,
		teacher_comment.clear_pronunciation AS clearPronunciation,
		teacher_comment.repetition AS repetition,
		teacher_comment.reading_skills AS readingSkills,
		teacher_comment.spelling_accuracy AS spellingAccuracy,
		teacher_comment.actively_interaction AS activelyInteraction,
		teacher_comment.performance AS performance,
		teacher_comment.performance_adjust AS performanceAdjust,
		teacher_comment.stars AS stars,
		teacher_comment.teacher_feedback AS teacherFeedback,
		teacher_comment.tips_for_other_teachers AS tipsForOtherTeachers,
		teacher_comment.report_issues AS reportIssues,
		teacher_comment.trial_level_result AS trialLevelResult
		FROM
		online_class_student
		INNER JOIN student ON (online_class_student.student_id = student.id)
		INNER JOIN online_class ON (online_class_student.online_class_id = online_class.id)
		INNER JOIN teacher_comment ON (online_class.id = teacher_comment.online_class_id)
		INNER JOIN lesson ON (online_class.lesson_id = lesson.id)
		WHERE
		online_class.teacher_id = #{teacherId} 
		AND lesson.serial_number NOT LIKE 'A%' 
		AND online_class.status != 'INVALID' 
		AND CONVERT_TZ(online_class.scheduled_date_time,'+08:00',#{toTZOffset}) LIKE CONCAT('',#{monthOfYear},'%')
		GROUP BY teacher_comment.online_class_id
		ORDER BY online_class.scheduled_date_time DESC
        <include refid="teacherCommentLimit" />
	</select>

	<select id="batchGetByOnlineClassIds" resultMap="teacherCommentResultMap" useCache="false">
		SELECT <include refid="teacherCommentColumns" /> FROM teacher_comment WHERE teacher_feedback IS NULL AND online_class_id IN
		<foreach collection="onlineClassIds" item="item" open="(" close=")" separator=",">
			#{item}
		</foreach>
	</select>
</mapper>
